<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Articles and Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabName === 'Chat') {
                loadChats();
            }
        }

        async function loadChats() {
            const response = await fetch('/chat/get_chats');
            const chats = await response.json();
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            chats.forEach(chat => {
                const chatElement = document.createElement('div');
                chatElement.className = 'mb-4 p-4 border rounded cursor-pointer hover:bg-gray-100';
                chatElement.innerHTML = `<strong>Chat ID:</strong> ${chat.id}`;
                chatElement.onclick = () => loadChat(chat.id);
                chatContainer.appendChild(chatElement);
            });
        }

        async function createChat() {
            const response = await fetch('/chat/create_chat', { method: 'POST' });
            const data = await response.json();
            const chatId = data.chat_id;
            loadChat(chatId);
        }

        async function loadChat(chatId) {
            const response = await fetch(`/chat/get_chat_history?chat_id=${chatId}`);
            const messages = await response.json();
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = message.role === 'user' ? 'mb-4 text-right' : 'mb-4 text-left';
                messageElement.innerHTML = `<strong>${message.role}:</strong> ${message.content}`;
                chatContainer.appendChild(messageElement);
            });
            const inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.id = 'chatInput';
            inputElement.className = 'w-full p-2 border border-gray-300 rounded mt-1';
            chatContainer.appendChild(inputElement);
            const sendButton = document.createElement('button');
            sendButton.className = 'bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2';
            sendButton.innerText = 'Send';
            sendButton.onclick = () => sendMessage(chatId);
            chatContainer.appendChild(sendButton);
        }

        async function sendMessage(chatId) {
            const inputElement = document.getElementById('chatInput');
            const message = inputElement.value;
            const response = await fetch('/chat/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: chatId, message: message })
            });
            const data = await response.json();
            const chatContainer = document.getElementById('chatContainer');
            const userMessageElement = document.createElement('div');
            userMessageElement.className = 'mb-4 text-right';
            userMessageElement.innerHTML = `<strong>user:</strong> ${message}`;
            chatContainer.appendChild(userMessageElement);
            const assistantMessageElement = document.createElement('div');
            assistantMessageElement.className = 'mb-4 text-left';
            assistantMessageElement.innerHTML = `<strong>assistant:</strong> ${data.content}`;
            chatContainer.appendChild(assistantMessageElement);
            inputElement.value = '';
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-900">
    <div class="container mx-auto p-4">
        <div class="tab flex mb-4">
            <button class="tablinks active px-4 py-2 bg-gray-200 rounded-t-lg" onclick="openTab(event, 'Articles')">Articles</button>
            <button class="tablinks px-4 py-2 bg-gray-200 rounded-t-lg ml-2" onclick="openTab(event, 'Chat')">Chat</button>
        </div>
        <div id="Articles" class="tabcontent" style="display: block;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Articles List</h2>
                <a href="{{ url_for('article.add_article') }}" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add New Article</a>
            </div>
            <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="py-2 px-4 text-left">Title</th>
                        <th class="py-2 px-4 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for article in articles %}
                    <tr class="border-b">
                        <td class="py-2 px-4">{{ article.article_name }}</td>
                        <td class="py-2 px-4 flex space-x-2">
                            <a href="{{ url_for('article.edit_article', article_id=article.id) }}" class="text-blue-500 hover:underline flex items-center">
                                <i class="fas fa-edit w-4 h-4 mr-1"></i> Edit
                            </a>
                            <form action="{{ url_for('article.delete_article') }}" method="post" class="inline">
                                <input type="hidden" name="article_id" value="{{ article.id }}">
                                <button type="submit" class="text-red-500 hover:underline flex items-center">
                                    <i class="fas fa-trash w-4 h-4 mr-1"></i> Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="Chat" class="tabcontent" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Chat</h2>
                <button onclick="createChat()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">New Chat</button>
            </div>
            <div id="chatContainer" class="bg-white p-6 rounded-lg shadow-md">
                <!-- Chat UI will be dynamically generated here -->
            </div>
        </div>
    </div>
</body>
</html>