{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Chat</h2>
    <button onclick="createChat()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">New Chat</button>
</div>
<div id="chatContainer" class="bg-white p-6 rounded-lg shadow-md">
    <!-- Chat UI will be dynamically generated here -->
</div>

<script>
    async function loadChats() {
        const response = await fetch('/chat/get_chats');
        const chats = await response.json();
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.innerHTML = '';
        chats.forEach(chat => {
            const chatElement = document.createElement('div');
            chatElement.className = 'mb-4 p-4 border rounded cursor-pointer hover:bg-gray-100';
            chatElement.innerHTML = `<strong>Chat ID:</strong> ${chat.id}`;
            chatElement.onclick = () => loadChat(chat.id);
            chatContainer.appendChild(chatElement);
        });
    }

    async function createChat() {
        const response = await fetch('/chat/create_chat', { method: 'POST' });
        const data = await response.json();
        const chatId = data.chat_id;
        loadChat(chatId);
    }

    async function loadChat(chatId) {
        const response = await fetch(`/chat/get_chat_history?chat_id=${chatId}`);
        const messages = await response.json();
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.innerHTML = '';
        messages.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.className = message.role === 'user' ? 'mb-4 text-right' : 'mb-4 text-left';
            messageElement.innerHTML = `<strong>${message.role}:</strong> ${message.content}`;
            chatContainer.appendChild(messageElement);
        });
        const inputElement = document.createElement('input');
        inputElement.type = 'text';
        inputElement.id = 'chatInput';
        inputElement.className = 'w-full p-2 border border-gray-300 rounded mt-1';
        chatContainer.appendChild(inputElement);
        const sendButton = document.createElement('button');
        sendButton.className = 'bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2';
        sendButton.innerText = 'Send';
        sendButton.onclick = () => sendMessage(chatId);
        chatContainer.appendChild(sendButton);
    }

    async function sendMessage(chatId) {
        const inputElement = document.getElementById('chatInput');
        const message = inputElement.value;
        const response = await fetch('/chat/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: chatId, message: message })
        });
        const data = await response.json();
        const chatContainer = document.getElementById('chatContainer');
        const userMessageElement = document.createElement('div');
        userMessageElement.className = 'mb-4 text-right';
        userMessageElement.innerHTML = `<strong>user:</strong> ${message}`;
        chatContainer.appendChild(userMessageElement);
        const assistantMessageElement = document.createElement('div');
        assistantMessageElement.className = 'mb-4 text-left';
        assistantMessageElement.innerHTML = `<strong>assistant:</strong> ${data.content}`;
        chatContainer.appendChild(assistantMessageElement);
        inputElement.value = '';
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        loadChats();
    });
</script>
{% endblock %}